YUI.add("gallery-more-loader",function(Y){var NME="moreLoader",SRC="container",EVT_START="start",EVT_LOAD="load",EVT_ERROR="error",EVT_MAX="max";function MoreLoader(config){MoreLoader.superclass.constructor.apply(this,arguments);}MoreLoader.NAME=NME;Y.extend(MoreLoader,Y.Base,{initializer:function(cfg){var src=this.get(SRC),moreBtn=this.get("moreBtn");this.publish(EVT_LOAD,{defaultFn:this._defCompleteFn,broadcast:2});this.publish(EVT_START,{});this.publish(EVT_ERROR,{});this.publish(EVT_MAX,{});this.start=this.get("start");this.max=this.get("max");this.count=this.get("count");this.loading=false;if(moreBtn){moreBtn.on("click",function(e){this.loadContent(this._getUrl(cfg.url,this.start,this.max));},this);}if(this.count===0||this.max>=this.count){this.fire(EVT_MAX);}if(this.get("autoRepeat")>0){this.startTimer();}},startTimer:function(){var repeat=this.get("autoRepeat")*1000,self=this;if(repeat>0&&!this.timer){this.timer=setInterval(function(){self.loadContent(self._getUrl(self.get("url"),self.start,self.max));},repeat);}},stopTimer:function(){if(this.timer){clearInterval(this.timer);}},loadContent:function(url){if(this.loading||(this.count>0&&this.start>=this.count)){return;}this.loading=true;this.fire(EVT_START,{url:url});Y.io(url,{on:{success:this._processResult,failure:this._processResult},timeour:10000,context:this});},_processResult:function(transactionid,res){var status=res.status,event=status<300?EVT_LOAD:EVT_ERROR,newContent=content=res.responseText,selector=this.get("contentSelector"),e={start:this.start,original:content,responseText:res.responseText,status:status};if(event===EVT_LOAD){if(newContent){newContent=Y.Node.create(newContent);if(selector!==null){newContent=newContent.one(selector);}}}e.content=newContent;this.loading=false;this.fire(event,e);},_defCompleteFn:function(e){this.start=this.start+this.max;var container=this.get(SRC);if(container&&e.content){var anim=e.content.one("> div")&&this.get("anim"),content=e.content.get("innerHTML");content=Y.Node.create(anim?'<div style="opacity:0;">'+content+"</div>":content);if(this.get("append")){container.append(content);}else{container.prepend(content);}if(this.get("processJSNodes")){var script=Y.Node.create(e.original).all("script").get("innerHTML").join("");eval(script);}if(anim){content.transition({opacity:{easing:"ease-in",duration:0.6,value:100}});}}if(this.count>0&&this.start>=this.count){this.fire(EVT_MAX);}},_getUrl:function(url,start,max){if(this.get("addPjaxParam")){url+=url.indexOf("?")>-1?"&":"?";url+="pjax=1";}if(url.indexOf("{st}")>-1){return Y.Lang.sub(url,{st:start,mx:max,dte:new Date().getMilliseconds()});}return url;},destructor:function(){this.stopTimer();this.get("moreBtn")&&this.get("moreBtn").destroy();}},{ATTRS:{url:null,start:{value:0},max:{value:0},count:{value:0},append:{value:true},anim:{value:true},autoRepeat:{value:0},container:{value:null,setter:Y.one},moreBtn:{value:null,setter:Y.one},contentSelector:{value:null},processJSNodes:{value:true},addPjaxParam:{value:true}}});Y.MoreLoader=MoreLoader;},"@VERSION@",{requires:["node-base","io-base","transition"]});